
# gofro-control

`gofro-control` — control-plane сервис платформы Gofro. Предоставляет HTTP API для панели и операторов, хранит подключенные ноды и проксирует команды в `gofro-node` по gRPC.

## Роль в системе

- входная точка управления нодами;
- orchestration-слой между UI и data-plane;
- единый публичный API для операций с нодами.

## Взаимодействие с другими сервисами

- принимает HTTP-запросы от `gofro-web` и внешних клиентов;
- вызывает gRPC методы `gofro-node` для выполнения команд;
- не управляет Xray локально и не заменяет data-plane.

## Функциональность (MVP)

- REST API на `:8080`;
- регистрация ноды по `host:port`;
- получение списка нод и состояния Xray;
- получение и обновление конфигурации Xray на ноде;
- команды `start/stop/restart` для Xray.

## Запуск

```bash
go mod download
go run ./cmd
```

Сервис доступен на `http://localhost:8080`.

## REST API

Базовый префикс: `/v1`.

### Ноды

- `GET /v1/nodes/` — список нод.
- `POST /v1/nodes/` — добавить ноду.

Пример тела:

```json
{
  "node_address": "127.0.0.1:50051"
}
```

### Конфиг ноды

- `GET /v1/nodes/{node_name}/config` — получить текущий конфиг.
- `PUT /v1/nodes/{node_name}/config` — обновить конфиг.

Пример тела:

```json
{
  "new_config": "{...}"
}
```

### Управление Xray

- `POST /v1/nodes/{node_name}/start`
- `POST /v1/nodes/{node_name}/stop`
- `POST /v1/nodes/{node_name}/restart`

### Ошибки

```json
{
  "error": "error message"
}
```

## Контракт с gofro-node (gRPC v1)

- `StartXray`
- `StopXray`
- `RestartXray`
- `UpdateXrayConfig`
- `GetNodeInfo`
- `GetCurrentConfig`

## Примеры curl

```bash
curl -X POST http://localhost:8080/v1/nodes/ \
  -H "Content-Type: application/json" \
  -d '{"node_address":"127.0.0.1:50051"}'

curl http://localhost:8080/v1/nodes/

curl -X POST http://localhost:8080/v1/nodes/node-1/restart
```

## Тесты

```bash
go test ./...
```

Примечание: `nodes/nodes_mananger_test.go` использует внешний адрес `147.45.214.213:50051`.

## Структура

- `cmd/main.go` — точка входа HTTP сервера
- `delivery/` — handlers, модели API, роутинг
- `nodes/` — менеджер нод и gRPC-клиент
- `gen/go/` — сгенерированные protobuf/gRPC файлы

## Ограничения

- список нод без персистентности;
- нет authN/authZ;
- gRPC подключение к нодам без TLS.
